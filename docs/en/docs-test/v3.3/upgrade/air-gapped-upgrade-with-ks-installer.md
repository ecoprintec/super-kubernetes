---
title: "Air-Gapped Upgrade with ks-installer"
keywords: "Air-Gapped, upgrade, Super Kubenetes, 3.3.0"
description: "Use ks-installer and offline package to upgrade Super Kubenetes."
linkTitle: "Air-Gapped Upgrade with ks-installer"
weight: 7500
---

ks-installer is recommended for users whose Kubernetes clusters were not set up by [KubeKey](../../installing-on-linux/introduction/kubekey/), but hosted by cloud vendors or created by themselves. This tutorial is for **upgrading Super Kubenetes only**. Cluster operators are responsible for upgrading Kubernetes beforehand.


## Prerequisites

- You need to have a Super Kubenetes cluster running v3.2.x. If your Super Kubenetes version is v3.1.x or earlier, upgrade to v3.2.x first.
- Read [Release Notes for 3.3.0](../../../v3.3/release/release-v330/) carefully.
- Back up any important component beforehand.
- A Docker registry. You need to have a Harbor or other Docker registries. For more information, see [Prepare a Private Image Registry](../../installing-on-linux/introduction/air-gapped-installation/#step-2-prepare-a-private-image-registry).
- Supported Kubernetes versions of Super Kubenetes 3.3.0: v1.19.x, v1.20.x, v1.21.x, v1.22.x, and v1.23.x (experimental support).

## Step 1: Prepare Installation Images

As you install Super Kubenetes in an air-gapped environment, you need to prepare an image package containing all the necessary images in advance.

1. Download the image list file `images-list.txt` from a machine that has access to Internet through the following command:

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  curl -L -O <a style="color:#ffffff; cursor:text;">https://github.com/Super Kubenetes/ks-installer/releases/download/v3.3.0/images-list.txt</a>
               </p>
            </code>
         </div>
      </pre>
    </article>

  <div className="notices note">
    <p>Note</p>
    <div>
      This file lists images under `##+modulename` based on different modules. You can add your own images to this file following the same rule. To view the complete file, see [Appendix](../../installing-on-linux/introduction/air-gapped-installation/#image-list-of-Super Kubenetes-v310).
    </div>
  </div>

2. Download `offline-installation-tool.sh`. 

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  curl -L -O <a style="color:#ffffff; cursor:text;">https://github.com/Super Kubenetes/ks-installer/releases/download/v3.3.0/offline-installation-tool.sh</a>
               </p>
            </code>
         </div>
      </pre>
   </article>

3. Make the `.sh` file executable.

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  chmod +x offline-installation-tool.sh
               </p>
            </code>
         </div>
      </pre>
   </article>

4. You can execute the command `./offline-installation-tool.sh -h` to see how to use the script:

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  root@master:/home/ubuntu# ./offline-installation-tool.sh -h
                  Usage:

                    ./offline-installation-tool.sh <span style="color:#f92672">[</span>-l IMAGES-LIST<span style="color:#f92672">]</span> <span style="color:#f92672">&nbsp;[</span>-d IMAGES-DIR<span style="color:#f92672">]</span> <span style="color:#f92672">&nbsp;[</span>-r PRIVATE-REGISTRY<span style="color:#f92672">]</span> <span style="color:#f92672">&nbsp;[</span>-v KUBERNETES-VERSION <span style="color:#f92672">]</span> 

                  Description:
                    -b                     : save kubernetes<span style="color:#e6db74">' binaries.
                    </span><span style="color:#e6db74">  -d IMAGES-DIR          : the dir of files (tar.gz) which generated by <span>`</span>docker save<span>`</span>. default: ./Super Kubenetes-images
                  </span><span style="color:#e6db74">&nbsp;&nbsp;-l IMAGES-LIST         : text file with list of images.
                  </span><span style="color:#e6db74">&nbsp;&nbsp;-r PRIVATE-REGISTRY    : target private registry:port.
                  </span><span style="color:#e6db74">&nbsp;&nbsp;-s                     : save model will be applied. Pull the images in the IMAGES-LIST and save images as a tar.gz file.
                  </span><span style="color:#e6db74">&nbsp;&nbsp;-v KUBERNETES-VERSION  : download kubernetes'</span> binaries. default: v1.17.9
                  &nbsp;&nbsp;-h                     : usage message
               </p>
            </code>
         </div>
      </pre>
   </article>

5. Pull images in `offline-installation-tool.sh`.

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  ./offline-installation-tool.sh -s -l images-list.txt -d ./Super Kubenetes-images
               </p>
            </code>
         </div>
      </pre>
   </article>

  <div className="notices note">
    <p>Note</p>
    <div>
      You can choose to pull images as needed. For example, you can delete `##k8s-images` and related images under it in `images-list.text` if you already have a Kubernetes cluster.
    </div>
  </div>

## Step 2: Push Images to Your Private Registry

Transfer your packaged image file to your local machine and execute the following command to push it to the registry.

<article className="highlight">
   <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
      <div className="copy-code-button" title="Copy Code"></div>
      <div className="code-over-div">
         <code>
            <p>
               ./offline-installation-tool.sh -l images-list.txt -d ./Super Kubenetes-images -r dockerhub.kubekey.local
            </p>
         </code>
      </div>
   </pre>
</article>

<div className="notices note">
   <p>Note</p>
   <div>
   The domain name is `dockerhub.kubekey.local` in the command. Make sure you use your **own registry address**.
   </div>
</div>

## Step 3: Download ks-installer

Similar to installing Super Kubenetes on an existing Kubernetes cluster in an online environment, you also need to download `Super Kubenetes-installer.yaml`.

1. Execute the following command to download ks-installer and transfer it to your machine that serves as the taskbox for installation.

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  curl -L -O <a style="color:#ffffff; cursor:text;">https://github.com/Super Kubenetes/ks-installer/releases/download/v3.3.0/Super Kubenetes-installer.yaml</a>
               </p>
            </code>
         </div>
      </pre>
   </article>
   
2. Verify that you have specified your private image registry in `spec.local_registry` in `cluster-configuration.yaml`. Note that if your existing cluster was installed in an air-gapped environment, you may already have this field specified. Otherwise, run the following command to edit `cluster-configuration.yaml` of your existing Super Kubenetes v3.1.x cluster and add the private image registry:

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  ./kk create config <span style="color:#f92672">[</span>--with-kubernetes version<span style="color:#f92672">]</span> <span style="color:#f92672">&nbsp;[</span>--with-Super Kubenetes version<span style="color:#f92672">]</span> <span style="color:#f92672">&nbsp;[(</span>-f | --file<span style="color:#f92672">)</span> path<span style="color:#f92672">]</span>
               </p>
            </code>
         </div>
      </pre>
   </article>

   For example, `dockerhub.kubekey.local` is the registry address in this tutorial, then use it as the value of `.spec.local_registry` as below:

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  <span style="color:#f92672">spec</span>: 
                  <span style="color:#f92672">&nbsp;&nbsp;persistence</span>: 
                  <span style="color:#f92672">&nbsp;&nbsp;&nbsp;&nbsp;storageClass</span>: <span style="color:#e6db74">""</span> 
                  <span style="color:#f92672">&nbsp;&nbsp;authentication</span>: 
                  <span style="color:#f92672">&nbsp;&nbsp;&nbsp;&nbsp;jwtSecret</span>: <span style="color:#e6db74">""</span> 
                  <span style="color:#f92672">&nbsp;&nbsp;local_registry</span>: <span style="color:#ae81ff">dockerhub.kubekey.local</span> <span style="color:#75715e"><span>&nbsp;#</span>&nbsp;Add this line manually; make sure you use your own registry address.</span>
               </p>
            </code>
         </div>
      </pre>
   </article>

3. Save `cluster-configuration.yaml` after you finish editing it. Replace `ks-installer` with your **own registry address** with the following command:

   <article className="highlight">
      <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
         <div className="copy-code-button" title="Copy Code"></div>
         <div className="code-over-div">
            <code>
               <p>
                  sed -i <span style="color:#e6db74">"s#^\s<span>*</span>image: Super Kubenetes.<span>*</span>/ks-installer:.<span>*</span><span>#</span>        image: dockerhub.kubekey.local/Super Kubenetes/ks-installer:v3.1.0<span>#</span>"</span> Super Kubenetes-installer.yaml
               </p>
            </code>
         </div>
      </pre>
   </article>

  <div className="notices warning">
    <p>Warning</p>
    <div>
      `dockerhub.kubekey.local` is the registry address in the command. Make sure you use your own registry address.
    </div>
  </div>

## Step 4: Upgrade Super Kubenetes

Execute the following command after you make sure that all steps above are completed.

<article className="highlight">
   <pre style="color: rgb(248, 248, 242); background: rgb(36, 46, 66); tab-size: 4;">
      <div className="copy-code-button" title="Copy Code"></div>
      <div className="code-over-div">
         <code>
            <p>
               kubectl apply -f Super Kubenetes-installer.yaml
            </p>
         </code>
      </div>
   </pre>
</article>

## Step 5: Verify Installation

When the installation finishes, you can see the content as follows:

<article className="highlight">
  <pre>
      <div className="copy-code-button" title="Copy Code"></div>
      <div className="code-over-div">
        <code>
          <p>
            <span style="color:#75715e">###########################################################</span> 
            <span style="color:#75715e"><span>#</span><span>#</span><span>#</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Welcome to Super Kubenetes!&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>#</span><span>#</span><span>#</span></span> 
            <span style="color:#75715e">###########################################################</span> 
            <span></span> 
            <span style="color:#ffffff">Console: <a style="color:#ffffff; cursor:text;">http://192.168.0.2:30880</a></span> 
            <span style="color:#ffffff">Account: admin</span> 
            <span style="color:#ffffff">Password: P@88w0rd</span> 
            <span></span> 
            <span style="color:#ffffff">NOTES：</span> 
            <span style="color:#ffffff">&nbsp;&nbsp;1. After you log into the console, please check the</span> 
            <span style="color:#ffffff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;monitoring status of service components in</span> 
            <span style="color:#ffffff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the</span>
            <span style="color:#ffffff">&nbsp;<span style="color:#e6db74">"Cluster Management"</span>. If any service is not</span> 
            <span style="color:#ffffff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ready, please wait patiently <span style="color:#66d9ef">until</span> all components </span> 
            <span style="color:#ffffff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;are up and running.</span> 
            <span style="color:#ffffff">&nbsp;&nbsp;2. Please change the default password after login.</span> 
            <span></span> 
            <span style="color:#75715e">###########################################################</span> <span style="color:#ffffff"> 
            <span></span><a style="color:#ffffff; cursor:text;">https://kubesphere.io</a><span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20xx-xx-xx xx:xx:xx</span> 
            <span style="color:#75715e">###########################################################</span> <span style="color:#ae81ff">
          </p>
        </code>
      </div>
  </pre>
</article>

Now, you will be able to access the web console of Super Kubenetes through `http://{IP}:30880` with the default account and password `admin/P@88w0rd`.

<div className="notices note">
  <p>Note</p>
  <div>
    To access the console, make sure port 30880 is opened in your security group.
  </div>
</div>